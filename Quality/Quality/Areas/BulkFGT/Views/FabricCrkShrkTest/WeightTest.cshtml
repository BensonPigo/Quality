@{
    ViewBag.Title = "Index";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

@model DatabaseObject.ResultModel.FabricCrkShrkTestWeight_Result

<link href="~/ThirdParty/plugins/DataTables/datatables.min.css" rel="stylesheet" />
<link href="~/ThirdParty/SciCustom/css/TableStyle.css" rel="stylesheet" />
<script src="~/ThirdParty/plugins/DataTables/datatables.min.js"></script>
<link href="~/ThirdParty/plugins/jquery-ui/jquery-ui.css" rel="stylesheet" />
<style type="text/css">

    .input-group {
        display: flex
    }

        .input-group > input:nth-child(1) {
            flex-grow: 2
        }

        .input-group > input:nth-child(2) {
            flex-grow: 1
        }

    tr.row-name {
        color: black;
    }

    .row {
        --bs-gutter-x: 1.5rem;
        --bs-gutter-y: 0;
        display: flex;
        flex-wrap: wrap;
        width: 95vw;
        margin-top: calc(var(--bs-gutter-y) * -1);
        margin-right: calc(var(--bs-gutter-x)/ -2);
        margin-left: calc(var(--bs-gutter-x)/ -2);
    }

    .button {
        background-color: #E00000; /* Red */
        border: none;
        color: white;
        padding: 6px 16px;
        text-align: center;
        text-decoration: none;
        display: inline-block;
        font-size: 16px;
    }

    .row > * {
        flex-shrink: 0;
        width: 100%;
        max-width: 100%;
        padding-left: calc(var(--bs-gutter-x)/ 2);
    }

    .col-auto {
        width: auto;
    }

        .col-auto > p {
            padding: 0
        }

    .White {
        color: white !important;
    }

    .Black {
        color: black !important;
    }

    .IsEditMode {
        color: white !important;
        cursor: pointer;
    }

    .IsEditModeQuery {
        color: gray !important;
        cursor: no-drop;
    }

    #ButtonMode {
        width: 82vw;
    }

    #myCartons_info, #myEndlineMoisture_info, #myView_info {
        color: white
    }

    .table_div tr td:nth-child(2n+1) {
        font-size: 1.2em;
        font-weight: bold;
    }


    .DataTable {
        width: 82vw;
        font-size: 1rem;
        font-weight: bold;
        border: solid 1px black;
        background-color: white;
    }

        .DataTable > tbody img {
            cursor: pointer;
        }

        .DataTable > tbody > tr:nth-of-type(odd) {
            background-color: #ffffff;
        }

        .DataTable > tbody > tr:nth-of-type(even) {
            background-color: #F0F2F2;
        }

        .DataTable > tbody > tr > td {
            border: solid 1px gray;
            padding: 0.5em;
            vertical-align: middle;
        }

    .width6vw {
        width: 6vw;
    }

    .width8vw {
        width: 8vw;
    }

    .width9vw {
        width: 9vw;
    }
</style>
@using (Html.BeginForm("WeightTestSave", ViewContext.RouteData.GetRequiredString("Controller"), FormMethod.Post, new { id = "DetailForm" }))
{
    <div class="main-content">
        <header class="page-header">
            <h3>
                <span>Fabric Crocking & Shrinkage Test</span>
            </h3>
            <div class="breadcrumb">
                <div>Home</div>
                <div>Fabric Crocking & Shrinkage Test</div>
                <div class="current">WeightTest</div>
            </div>
        </header>
        <div class="main-area">
            <div class="content-scroll">
                <div class="inner-scroll">
                    <div>
                        @*按鈕*@
                        <div>
                            <table id="ButtonMode">
                                <tbody>
                                    <tr>
                                        <td>
                                            <h4 id="Exit" style="margin-right: 1em;">
                                                <a href="@Url.Action("IndexBack", ViewContext.RouteData.GetRequiredString("Controller"), new { POID = Model.Weight_Main.POID })">
                                                    <img src="~/Image/Icon/Exit.png" width="30" />
                                                    Exit
                                                </a>
                                            </h4>
                                        </td>

                                        <td>
                                            <h4 id="Edit" style="margin-right: 1em;">
                                                <img src="~/Image/Icon/Edit.png" width="30" />
                                                Edit
                                            </h4>
                                        </td>
                                        <td>
                                            <h4 id="Save" style="margin-right: 1em;">
                                                <img src="~/Image/Icon/Save.png" width="30" />
                                                Save
                                            </h4>
                                        </td>
                                        <td>
                                            <h4 id="Encode" style="margin-right: 1em;">
                                                <img src="~/Image/Icon/Lock.png" width="30" />
                                                Encode
                                            </h4>
                                        </td>

                                        <td>
                                            <h4 id="Amend" style="margin-right: 1em;">
                                                <img src="~/Image/Icon/Unlock.png" width="30" />
                                                Amend
                                            </h4>
                                        </td>
                                        <td>
                                            <h4 id="Excel" style="margin-right: 1em;">
                                                <img src="~/Image/Icon/XLS.png" width="40" />
                                                Excel
                                            </h4>
                                        </td>
                                        <td>
                                            <h4 id="PDF" style="margin-right: 1em;">
                                                <img src="~/Image/Icon/PDF.png" width="30" />
                                                PDF(Excel)
                                            </h4>
                                        </td>
                                        <td>
                                            <h4 id="SendMail" style="margin-right: 1em;">
                                                <img src="~/Image/Icon/SendMail.png" width="30" />
                                                Send to MR
                                            </h4>
                                        </td>
                                        <td style="width: 20%;">
                                        </td>
                                        <td align="right">
                                            <h4 id="Undo" style="margin-right: 1em;">
                                                <img src="~/Image/Icon/Undo.png" width="30" />
                                                Undo
                                            </h4>
                                        </td>
                                        <td align="right">
                                            <h4 id="New" style=" margin-right: 1em;">
                                                <img src="~/Image/Icon/New.png" width="30" />
                                                New Item
                                            </h4>
                                        </td>
</tbody>
                            </table>
                        </div>
                    </div>
                    <div>
                        @*主-明細*@
                        <div style="margin-top: 1em;">
                            <table class="DataTable MainTable">
                                <tbody>
                                    @if (Model != null)
                                    {
                                        @Html.HiddenFor(o => o.ID)
                                    }

                                    <tr>
                                        <td style="width: 10vw;"><h5>SP#</h5></td>
                                        <td style="width: 15vw;">
                                            @Html.DisplayFor(o => o.Weight_Main.POID)
                                        </td>
                                        <td style="        width: 15vw;"><h5>SEQ#</h5></td>
                                        <td style="width: 20vw;">
                                            @Html.DisplayFor(o => o.Weight_Main.SEQ)
                                        </td>
                                        <td style="width: 15vw;"><h5>Color</h5></td>
                                        <td style="width: 20vw;">
                                            @Html.DisplayFor(o => o.Weight_Main.ColorID)
                                        </td>
                                    </tr>
                                    <tr>
                                        <td><h5>Arrive Qty</h5></td>
                                        <td>
                                            @Html.DisplayFor(o => o.Weight_Main.ArriveQty)
                                        </td>
                                        <td><h5>Arrive W/H Date</h5></td>
                                        <td>
                                            @Html.ValueFor(o => o.Weight_Main.WhseArrival, "{0:yyyy/MM/dd}")
                                        </td>
                                        <td><h5>WK#</h5></td>
                                        <td>
                                            @Html.DisplayFor(o => o.Weight_Main.ExportID)
                                        </td>
                                    </tr>
                                    <tr>
                                        <td><h5>Supp</h5></td>
                                        <td>
                                            @Html.DisplayFor(o => o.Weight_Main.Supp)
                                        </td>
                                        <td><h5>Result</h5></td>
                                        <td>
                                            @{
                                                string styleColor = "";
                                                if (Model.Weight_Main.Weight == "Pass")
                                                {
                                                    styleColor = "blue";
                                                }
                                                else
                                                {
                                                    styleColor = "red";
                                                }
                                            }
                                            <font class="@styleColor">@Html.DisplayFor(o => o.Weight_Main.Weight)</font>
                                        </td>
                                        <td><h5>N/A</h5></td>
                                        <td>
                                            @Html.CheckBox("Weight_Main.NonWeight", Convert.ToBoolean(Model.Weight_Main.NonWeight), new { @disabled = "disabled" })
                                        </td>
                                    </tr>
                                    <tr>
                                        <td><h5>Style#</h5></td>
                                        <td>
                                            @Html.DisplayFor(o => o.Weight_Main.StyleID)
                                        </td>
                                        <td><h5>Report Date</h5></td>
                                        <td>
                                            @Html.ValueFor(o => o.Weight_Main.WeightDate, "{0:yyyy/MM/dd}")
                                        </td>
                                        <td><h5>Weight Inspector</h5></td>
                                        <td>
                                            @Html.DisplayFor(o => o.Weight_Main.WeightInspector)
                                        </td>
                                    </tr>
                                    <tr>
                                        <td><h5>Brand</h5></td>
                                        <td>
                                            @Html.DisplayFor(o => o.Weight_Main.BrandID)
                                        </td>
                                        <td><h5>SCI Refno</h5></td>
                                        <td>
                                            @Html.DisplayFor(o => o.Weight_Main.SCIRefno)
                                        </td>
                                        <td><h5>Brand Refno</h5></td>
                                        <td>
                                            @Html.DisplayFor(o => o.Weight_Main.Refno)
                                        </td>
                                    </tr>
                                    <tr>
                                        <td><h5>Description</h5></td>
                                        <td colspan="5">
                                            @Html.DisplayFor(o => o.Weight_Main.DescDetail)
                                        </td>
                                    </tr>
                                    <tr>
                                        <td><h5>Remark</h5></td>
                                        <td colspan="5">
                                            @Html.TextBoxFor(o => o.Weight_Main.WeightRemark, new { @style = "width:100%", @disabled = "disabled" })
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                    <div style="margin-top: 1em; overflow:auto">
                        <table cellspacing="100" id="weight_Detail" class="DataTable DetailTable table table-striped display;">
                            <thead>
                                <tr class="row-name" id="row-name">
                                    <th style="width:5vw">Submit Date</th>
                                    <th style="width:5vw">Roll#</th>
                                    <th style="width:5vw">Dyelot</th>
                                    <th style="width:5vw">Declared Mass</th>
                                    <th style="width:5vw">Average Mass</th>
                                    <th style="width:5vw">Diff%</th>
                                    <th style="width:5vw">Result</th>
                                    <th style="width:5vw">Insp. Date</th>
                                    <th style="width:5vw">Lab Tech</th>
                                    <th style="width:5vw">Name</th>
                                    <th style="width:5vw">Remark</th>
                                    <th style="width:5vw">Last update</th>
                                    <th style="width:5vw"></th>
                                </tr>
                            </thead>
                            <tbody>
                                @for (int i = 0; i < Model.Weight_Detail.Count; i++)
                                {
                                    <tr idx="@i" class="row-content" style="vertical-align: middle; text-align: center;">
                                        <td>
                                            @Html.HiddenFor(modelItem => Model.Weight_Detail[i].ID, new { @class = "keepValue" })
                                            @Html.TextBoxFor(modelItem => Model.Weight_Detail[i].SubmitDate, "{0:yyyy/MM/dd}", new { @class = "date-picker width9vw" })
                                        </td>
                                        <td>
                                            <div class="input-group">
                                                @Html.TextBoxFor(modelItem => Model.Weight_Detail[i].Roll, new { @class = "inputRollSelectItem width6vw" })
                                                <input type="button" class="site-btn btn-blue btnRollSelectItem" style="margin:0;border:0;" value="..." />
                                            </div>
                                        </td>
                                        <td>
                                            <div class="input-group">
                                                @Html.TextBoxFor(modelItem => Model.Weight_Detail[i].Dyelot, new { @class = "inputRollSelectItem width8vw" })
                                                <input type="button" class="site-btn btn-blue btnRollSelectItem" style="margin:0;border:0;" value="..." />
                                            </div>
                                        </td>
                                        <td>
                                            @Html.TextBoxFor(modelItem => Model.Weight_Detail[i].WeightM2, new { @class = "keepValue", @type = "number", @step = "0.1", @readonly = "readonly" })
                                        </td>
                                        <td>
                                            @Html.TextBoxFor(modelItem => Model.Weight_Detail[i].AverageWeightM2, new { @type = "number", @step = "0.1", @min = "0", @onchange = "value=modifyAverageWeightM2(value,this)" })
                                        </td>
                                        <td>
                                            @Html.TextBoxFor(modelItem => Model.Weight_Detail[i].Difference, new { @type = "number", @step = "0.1", @readonly = "readonly" })
                                        </td>
                                        <td>
                                            @{
                                                styleColor = "red width6vw";
                                                if (Model.Weight_Detail[i].Result == "Pass")
                                                {
                                                    styleColor = "blue width6vw";
                                                }
                                            }
                                            <select id="Weight_Detail_@{@i}_Result" name="Weight_Detail[@i].Result" disabled="disabled" class="@styleColor Result" style="width:157px;">
                                                @foreach (var item in (List<SelectListItem>)ViewBag.ResultList)
                                                {
                                                    string selected = item.Text.Equals(Model.Weight_Detail[i].Result) ? "selected" : "";
                                                    <option value="@item.Value" @selected>@item.Text</option>
                                                }
                                            </select>
                                        </td>
                                        <td>
                                            @Html.TextBoxFor(modelItem => Model.Weight_Detail[i].Inspdate, "{0:yyyy/MM/dd}", new { @class = "date-picker width9vw" })
                                        </td>
                                        <td>
                                            <div class="input-group">
                                                @Html.TextBoxFor(modelItem => Model.Weight_Detail[i].Inspector, new { @class = "inputInspectorSelectItem" })
                                                <input id="btnDetailInspectorSelectItem" type="button" class="site-btn btn-blue btnInspectorSelectItem" style="margin:0;border:0;" value="..." />
                                            </div>
                                        </td>
                                        <td>
                                            @Html.TextBoxFor(modelItem => Model.Weight_Detail[i].Name, new { @readonly = "readonly" })
                                        </td>
                                        <td>
                                            @Html.TextBoxFor(modelItem => Model.Weight_Detail[i].Remark)
                                        </td>
                                        <td>
                                            @Html.TextBoxFor(modelItem => Model.Weight_Detail[i].LastUpdate, new { @readonly = "readonly" })
                                        </td>
                                        <td>
                                            <img class='detailDelete' src="~/Image/Icon/Delete.png" style="min-width:30px">
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
}
<script type="text/javascript">
    var msg;
    var EditMode;
    var True = true;
    var False = false;
    var hiddenColumns = [];
    var poid = '@Model.Weight_Main.POID';
    var seq1 = '@Model.Weight_Main.SEQ'.split(' ')[0];
    var seq2 = '@Model.Weight_Main.SEQ'.split(' ')[1];

    $(function () {
        msg = new MessagerAlert();
        EditMode = false;
        @Html.Raw(Model.ErrorMessage);
        IsEditModeChange();
    });

    function IsEditModeChange() {
        EditModeButtionBind();
        $('#Picture').addClass("IsEditMode");
        // 按編輯為控制disabled，如果是編輯模式下不給使用者操作，請在元件身上加上readonly
        if (EditMode) {

            $("#Edit, #Encode, #Amend, #Excel ,#PDF ,#SendMail").removeClass("IsEditMode");
            $('#Encode, #Amend, #Excel ,#PDF ,#SendMail').unbind('click');

            $('#Save, #New, #Undo').addClass("IsEditMode");
            $(".MainEdit").removeAttr("disabled", "disabled");
            $(".DetailTable input,.DetailTable select:not(.Result), #Weight_Main_WeightRemark").removeAttr("disabled", "disabled");
            $(".detailDelete").show();
            DetailButtonBind();
        }
        else {
            $('#Save, #New, #Undo').unbind('click').removeClass("IsEditMode");
            $(".MainEdit").attr("disabled", "disabled");
            $(".DetailTable input,.DetailTable select:not(.Result), #Weight_Main_WeightRemark").attr("disabled", "disabled");
            $(".detailDelete").hide();
            $('#Excel ,#PDF ,#SendMail').addClass("IsEditMode");

            if (@Model.Weight_Main.WeightEncode == false) {
                $("#Edit, #Encode").addClass("IsEditMode");
                $("#Amend").unbind('click');
            }

            if (@Model.Weight_Main.WeightEncode == true) {
                $("#Amend").addClass("IsEditMode");
                $("#Edit, #Encode").unbind('click');
            }
        }
    }

    function EditModeButtionBind() {
        $('#Edit').on('click', function () {
            if ('@Model.ID' != '') {
                EditMode = true;
                IsEditModeChange();
            }
        });

        $('#Save').on('click', function (e) {
            var detail = [];
            var ErrMsg = "";

            $('.DetailTable > tbody > tr').each(function (index, data) {
                let idx = $(this).closest('tr').attr('idx');
                let roll = $('Weight_Detail__' + idx + '__Roll').val();
                let dyelot = $('#Weight_Detail_' + idx + '__Dyelot').val();


                if (roll == "" || dyelot == "") {
                    ErrMsg += "< Roll, Dyelot > can not be empty.";
                    return false;
                }

                let averageWeightM2 = parseFloat($('#Weight_Detail_' + idx + '__AverageWeightM2').val());

                if (isNaN(averageWeightM2) || averageWeightM2 <= 0) {
                    ErrMsg += "< Average Mass > can not be empty.";
                    return false;
                }

                let inspdate = $('#Weight_Detail_' + idx + '__Inspdate').val();
                if (inspdate == "") {
                    ErrMsg += "< Inspection Date > can not be empty.";
                    return false;
                }

                let inspector = $('#Weight_Detail_' + idx + '__Inspector').val();
                if (inspector == "") {
                    ErrMsg += "< Lab Tech> can not be empty.";
                    return false;
                }
            });

            if (ErrMsg != "") {
                msg.WithError(ErrMsg);
                return;
            }

            $('.DetailTable > tbody > tr').each(function (index, data) {
                var idx = $(this).closest('tr').attr('idx');
                if (idx != index) {
                    $.each($(this).find("input[id^='Weight_Detail']"), function () {
                        var tableName = $(this).attr('name').substr(0, $(this).attr('name').indexOf("["));
                        var rollName = $(this).attr('name').substr($(this).attr('name').indexOf("]") + 2, $(this).attr('name').length - $(this).attr('name').indexOf("]"));
                        $(this).attr("id", tableName + "_" + index.toString() + "__" + rollName);
                        $(this).attr("name", tableName + "[" + index.toString() + "]." + rollName);
                    });

                    $.each($(this).find("select[id^='Weight_Detail']"), function () {
                        var tableName = $(this).attr('name').substr(0, $(this).attr('name').indexOf("["));
                        var rollName = $(this).attr('name').substr($(this).attr('name').indexOf("]") + 2, $(this).attr('name').length - $(this).attr('name').indexOf("]"));
                        $(this).attr("id", tableName + "_" + index.toString() + "__" + rollName);
                        $(this).attr("name", tableName + "[" + index.toString() + "]." + rollName);
                    });
                }
            });

            document.getElementById("DetailForm").submit();
        });

        $('#New').on('click', function () {
            AddDetailRow();
        });

        $('#Undo').on('click', function () {
            location.reload();
        });

        $('#Excel').unbind('click').on('click', function () {
            ToReport(false);
        });

        $('#PDF').unbind('click').on('click', function () {
            ToReport(true);
        });


        $('#SendMail').unbind('click').on('click', function () {
            var para = '?Subject=@Model.Weight_Main.MailSubject&body=@Model.Weight_Main.MailDesc';
            window.open('@Url.Action("SendMailer", "SendMailAttachfiles", new { Area=""})' + para, 'SendMail', config = 'toolbar=no,status=no,location=no,width=800,height=400');
        });

        if (@Model.Weight_Main.WeightEncode == false) {
            $('#Encode').on('click', function (e) {
                var detail = [];
                var ErrMsg = "";

                // 表身是否至少有一列資料
                var rowCount = $('.DetailTable tbody tr').length;
                if (rowCount == 0) {
                    msg.WithError('Please test one Roll least.');
                    return;
                }

                $.ajax({
                    url: "@Url.Action("Encode_Weight", "FabricCrkShrkTest", new { Area = "BulkFGT" })",
                    type: 'POST',
                    contentType: "application/json; charset=utf-8",
                    data: JSON.stringify({ ID: $('#ID').val() }),
                    async: false,
                    success: function (data) {
                        if (data.Result) {
                            if (data.testResult == "Fail") {
                                FailMail();
                            }
                            else {
                                msg.WithSuccesCheck("Success", function () {
                                    location.reload();
                                });
                            }
                        }
                        else {
                            msg.WithError(data.ErrorMessage);
                        }
                    },
                    error: function (xhr, ajaxOptions, thrownError) {
                        console.log(xhr.responseText);
                    }
                });
            });
        }

        if (@Model.Weight_Main.WeightEncode  == true) {
            $('#Amend').on('click', function (e) {
                // 表身是否至少有一列資料
                var rowCount = $('.DetailTable tbody tr').length;
                if (rowCount == 0) {
                    msg.WithError('Please test one Roll least.');
                    return;
                }

                $.ajax({
                    url: "@Url.Action("Amend_Weight", "FabricCrkShrkTest", new { Area = "BulkFGT" })",
                    type: 'POST',
                    contentType: "application/json; charset=utf-8",
                    data: JSON.stringify({ ID: $('#ID').val() }),
                    async: false,
                    success: function (data) {
                        if (data.Result) {
                            msg.WithSuccesCheck("Success", function () {
                                location.reload();
                            });
                        }
                        else {
                            msg.WithError(data.ErrorMessage);
                        }
                    },
                    error: function (xhr, ajaxOptions, thrownError) {
                        console.log(xhr.responseText);
                    }
                });
            });
        }
    }

    function ToReport(IsToPDF) {

        msg.WithInfoTimer("Report Generating...");

        $.ajax({
            url: "@Url.Action("Report_Weight", "FabricCrkShrkTest", new { Area = "BulkFGT" })",
            type: 'POST',
            contentType: "application/json; charset=utf-8",
            data: JSON.stringify({ ID: $('#ID').val(), IsToPDF: IsToPDF }),
            async: true,
            success: function (data) {
                if (data.Result) {
                    window.location.href = data.reportPath;
                }
                else {
                    msg.WithError(data.ErrorMessage);
                }
            },
            error: function (xhr, ajaxOptions, thrownError) {
                console.log(xhr.responseText);
                msg.WithError("Error generating report.");
            }
        });
    }

    function FailMail() {
        var para = "?Title=" + $('.page-header span').html() + "&FactoryID=@ViewBag.FactoryID&Type=BulkFGT";
        window.open('@Url.Action("TestFailMailList", "PublicWindow",new { Area=""})' + para, 'Mail List', config = 'toolbar=no,status=no,location=no,width=650,height=750');
    }

    function GetTestFailMailList(data) {
        var to = "";
        var cc = "";
        $.each(data, function (index, value) {
            to += value.To + ';';
            cc += value.CC + ';';
        });
        var poid = '@Model.Weight_Main.POID';

        $.ajax({
            url: "@Url.Action("WeightSendMail", "FabricCrkShrkTest", new { Area = "BulkFGT" })",
            type: 'POST',
            contentType: "application/json; charset=utf-8",
            data: JSON.stringify({ ID: $('#ID').val(), TO: to, CC: cc, OrderID: poid }),
            async: false,
            success: function (data) {
                if (data.result) {
                    msg.WithSuccesCheck("Success", function () {
                        location.reload();
                    });
                }
                else {
                    msg.WithWarningCheck(data.resultMsg, function () {
                        location.reload();
                    });
                }
            },
            error: function (xhr, ajaxOptions, thrownError) {
                msg.WithWarningCheck(xhr.responseText, function () {
                    location.reload();
                });
            }
        });
    }

    function GetSendMailer(data) {
        var to = data.To;
        var cc = data.CC;
        var poid = '@Model.Weight_Main.POID';
        var subject = data.Subject;
        var body = data.Body;
        var rawFiles = data.RawFiles;

        if (to != "") {

            let formData = new FormData();
            formData.append('ID', $("#ID").val());
            formData.append('OrderID', poid);
            formData.append('To', to);
            formData.append('CC', cc);
            formData.append('Subject', subject);
            formData.append('Body', body);

            $.each(rawFiles, function () {
                formData.append('Files', this);
            })

            $.ajax({
                url: "@Url.Action("WeightSendMail", "FabricCrkShrkTest", new { Area = "BulkFGT" })",
                type: 'POST',
                contentType: false,
                data: formData,
                async: false,
                processData: false,
                success: function (data) {
                    if (data.result) {
                        msg.WithSuccesCheck("Success", function () {
                            location.reload();
                        });
                    }
                    else {
                        msg.WithWarningCheck(data.resultMsg, function () {
                            location.reload();
                        });
                    }
                },
                error: function (xhr, ajaxOptions, thrownError) {
                    // console.log(xhr.responseText);
                    msg.WithWarningCheck(xhr.responseText, function () {
                        location.reload();
                    });
                }
            });
        }
    }

    function AddDetailRow() {
        var lastNO;
        if ($('.DetailTable > tbody > tr').length > 0) {
            lastNO = parseInt($('.DetailTable > tbody > tr:last-child').attr('idx')) + 1;
        }
        else {
            lastNO = 0;
        }

        const today = new Date();
        const yyyy = today.getFullYear();
        const mm = String(today.getMonth() + 1).padStart(2, '0');
        const dd = String(today.getDate()).padStart(2, '0');
        let pToday = `${yyyy}/${mm}/${dd}`;

        let value = @Model.Weight_Main.WeightM2.ToString("#,##0.0");

        let newRow = $(`
<tr idx="`+ lastNO +`" class="row-content" style="vertical-align: middle; text-align: center;">
    <td>
        <input data-val="true" data-val-number="欄位 ID 必須是數字。" data-val-required="ID 欄位是必要項。" id="Weight_Detail_`+ lastNO + `__ID" name="Weight_Detail[` + lastNO +`].ID" type="hidden" value="`+@Model.ID+`">
        <input class="date-picker width9vw" data-val="true" data-val-date="欄位 SubmitDate 必須是日期。" name="Weight_Detail[`+ lastNO + `].SubmitDate" type="text" value="` + pToday +`" id="Weight_Detail_` + lastNO +`__SubmitDate">
    </td>
    <td>
        <div class="input-group">
            <input class="inputRollSelectItem width6vw" id="Weight_Detail_`+ lastNO + `__Roll" name="Weight_Detail[` + lastNO +`].Roll" type="text" value="">
            <input type="button" class="site-btn btn-blue btnRollSelectItem" style="margin:0;border:0;" value="...">
        </div>
    </td>
    <td>
        <div class="input-group">
            <input class="inputRollSelectItem width8vw" id="Weight_Detail_`+ lastNO + `__Dyelot" name="Weight_Detail[` + lastNO +`].Dyelot" type="text" value="">
            <input type="button" class="site-btn btn-blue btnRollSelectItem" style="margin:0;border:0;" value="...">
        </div>
    </td>
    <td>
        <input data-val="true" data-val-number="欄位 WeightM2 必須是數字。" data-val-required="WeightM2 欄位是必要項。" id="Weight_Detail_`+ lastNO + `__WeightM2" name="Weight_Detail[` + lastNO + `].WeightM2" readonly="readonly" step="0.1" type="number" value="` + value.toFixed(1)+`">
    </td>
    <td>
        <input data-val="true" data-val-number="欄位 AverageWeightM2 必須是數字。" data-val-required="AverageWeightM2 欄位是必要項。" id="Weight_Detail_`+ lastNO + `__AverageWeightM2" min="0" name="Weight_Detail[` + lastNO +`].AverageWeightM2" onchange="value=modifyAverageWeightM2(value,this)" step="0.1" type="number" value="">
    </td>
    <td>
        <input data-val="true" data-val-number="欄位 Difference 必須是數字。" data-val-required="Difference 欄位是必要項。" id="Weight_Detail_`+ lastNO + `__Difference" name="Weight_Detail[` + lastNO +`].Difference" readonly="readonly" step="0.1" type="number" value="">
    </td>
    <td>
        <select id="Weight_Detail_`+ lastNO + `_Result" name="Weight_Detail[` + lastNO +`].Result" disabled="disabled" class="blue width6vw Result" style="width:157px;">
            @foreach (var item in (List<SelectListItem>)ViewBag.ResultList)
            {
                <option value="@item.Value">@item.Text</option>
            }
        </select>
    </td>
    <td>
        <input class="date-picker width9vw" data-val="true" data-val-date="欄位 Inspdate 必須是日期。" name="Weight_Detail[`+ lastNO + `].Inspdate" type="text" value="" id="Weight_Detail_` + lastNO +`__Inspdate">
    </td>
    <td>
        <div class="input-group">
            <input class="inputInspectorSelectItem" id="Weight_Detail_`+ lastNO + `__Inspector" name="Weight_Detail[` + lastNO +`].Inspector" type="text" value="">
            <input id="btnDetailInspectorSelectItem" type="button" class="site-btn btn-blue btnInspectorSelectItem" style="margin:0;border:0;" value="...">
        </div>
    </td>
    <td>
        <input id="Weight_Detail_`+ lastNO + `__Name" name="Weight_Detail[` + lastNO +`].Name" readonly="readonly" type="text" value="">
    </td>
    <td>
        <input id="Weight_Detail_`+ lastNO + `__Remark" name="Weight_Detail[` + lastNO +`].Remark" type="text" value="">
    </td>
    <td>
        <input id="Weight_Detail_`+ lastNO + `__LastUpdate" name="Weight_Detail[` + lastNO +`].LastUpdate" readonly="readonly" type="text" value="">
    </td>
    <td>
        <img class="detailDelete" src="/Image/Icon/Delete.png" style="min-width: 30px;">
    </td>
</tr>
        `);

        $('.DetailTable > thead > tr').show();
        $('.DetailTable > tbody').append(newRow);

        $(hiddenColumns).each(function () {
            var inputObj = $('.DetailTable td:nth-child(' + this + ')').children();
            inputObj.val(0);

            $('.DetailTable td:nth-child(' + this + ')').hide();
        });

        DetailButtonBind();
        $('.date-picker').datepicker({ changeYear: true, changeMonth: true, currentText: "Now" });
    }

    function changeResultColor(obj) {
        var result = $(obj).val();
        if (result == "Pass") {
            $(obj).removeClass('red').addClass('blue');
        }
        else {
            $(obj).removeClass('blue').addClass('red');
        }
    }

    function DetailButtonBind() {
        // 卸掉重新綁定
        $('.inputRollSelectItem').unbind('blur').on('blur', function () {
            var targetID = $(this).closest('tr').attr('idx');
            var checkValue = $("#Weight_Detail_" + targetID + "__Roll").val();
            var receivingID = '@Model.Weight_Main.ReceivingID';

            if (checkValue == "") {
                $("#Weight_Detail_" + targetID + "__Dyelot").val('');
                return;
            }

            $.ajax({
                url: "@Url.Action("AllReceivingDetailList", "PublicWindow",new { Area=""})",
                type: 'POST',
                contentType: "application/json; charset=utf-8",
                data: JSON.stringify({ POID: poid, Seq1: seq1, Seq2: seq2, Roll: checkValue, ReceivingID: receivingID, ReturnType: "JSON" }),
                async: true,
                success: function (data) {
                    if (data.length == 0) {
                        $("#Weight_Detail_" + targetID + "__Roll").val('');
                        $("#Weight_Detail_" + targetID + "__Dyelot").val('');
                        msg.WithError('Roll# Not Found');
                    }
                    else {
                        $("#Weight_Detail_" + targetID + "__Roll").val(data[0].Roll);
                        $("#Weight_Detail_" + targetID + "__Dyelot").val(data[0].Dyelot);
                    }
                },
                error: function (xhr, ajaxOptions, thrownError) {
                    console.log(xhr.responseText);
                }
            });
        });

        $('.btnRollSelectItem').unbind('click').on('click', function () {
            var targetID = $(this).closest('tr').attr('idx');
            var receivingID = '@Model.Weight_Main.ReceivingID';
            var para = "?POID=" + poid + "&Seq1=" + seq1 + "&Seq2=" + seq2 + "&TargetID=" + targetID + "&ReceivingID=" + receivingID;
            window.open('@Url.Action("AllReceivingDetailList", "PublicWindow",new{Area=""})' + para, 'Roll', config = 'toolbar=no,status=no,location=no,width=950,height=650');
        });

        $('.inputInspectorSelectItem').unbind('blur').on('blur', function () {
            var targetID = $(this).closest('tr').attr('idx');

            if ($(this).val() == "") {
                $("#Weight_Detail_" + targetID + "__Name").val('');
                $("#Weight_Detail_" + targetID + "__Remark").val('');
                return;
            }

            $.ajax({
                url: "@Url.Action("Pass1List", "PublicWindow",new { Area=""})",
                type: 'POST',
                contentType: "application/json; charset=utf-8",
                data: JSON.stringify({ ID: $(this).val(), ReturnType: "JSON" }),
                async: true,
                success: function (data) {
                    if (data.length == 0) {
                        $("#Weight_Detail_" + targetID + "__Inspector").val('');
                        $("#Weight_Detail_" + targetID + "__Name").val('');
                        msg.WithError('Lab Tech Not Found');
                    }
                    else {
                        $("#Weight_Detail_" + targetID + "__Inspector").val(data[0].ID);
                        $("#Weight_Detail_" + targetID + "__Name").val(data[0].Name + ' Ext.' + data[0].ExtNo);
                    }
                },
                error: function (xhr, ajaxOptions, thrownError) {
                    console.log(xhr.responseText);
                }
            });
        });

        $('.btnInspectorSelectItem').unbind('click').on('click', function () {
            var targetID = $(this).closest('tr').attr('idx');
            var para = "?TargetID=" + targetID;
            window.open('@Url.Action("Pass1List", "PublicWindow",new{Area=""})' + para, 'Roll', config = 'toolbar=no,status=no,location=no,width=950,height=650');
        });

        $('.detailDelete').unbind('click').on('click', function () {
            var t = $(this).closest('tr');

            msg.WithConfirm('Do you want to delete the data ?',
                function () {
                    t.remove();
                    msg.WithSuccess("Delete Success");
                }, null);
        });
    }

    function GetAllReceivingDetail(data, targetID) {
        $("#Weight_Detail_" + targetID + "__Roll").val(data.Roll);
        $("#Weight_Detail_" + targetID + "__Dyelot").val(data.Dyelot);
    }

    function GetPass1(data, targetID) {
        if (targetID.includes('Main')) {
            $(`#${targetID}`).val(data.ID);
            $(`#${targetID}Name`).val(data.Name);
        }
        else {
            $("#Weight_Detail_" + targetID + "__Inspector").val(data.ID);
            $("#Weight_Detail_" + targetID + "__Name").val(data.Name + ' Ext.' + data.ExtNo);
        }
    }

    function modifyAverageWeightM2(value, obj) {
        let averageWeightM2 = Number.parseFloat(value).toFixed(1)
        let idx = $(obj).closest('tr').attr('idx');
        let weightM2 = @Model.Weight_Main.WeightM2;

        if (weightM2 === 0) {
            $('#Weight_Detail_' + idx + '__Difference').val(0);
            $('#Weight_Detail_' + idx + '_Result').val('Pass');
            $('#Weight_Detail_' + idx + '_Result').removeClass('blue').removeClass('red').addClass('blue');
            return;
        }
        let diff = ((averageWeightM2 - weightM2) / weightM2) * 100;
        diff = Math.round(diff * 100) / 100;

        $('#Weight_Detail_' + idx + '__Difference').val(diff);

        if (Math.abs(diff) <= 5) {
            $('#Weight_Detail_' + idx + '_Result').val('Pass');
            $('#Weight_Detail_' + idx + '_Result').removeClass('blue').removeClass('red').addClass('blue');
        }
        else {
            $('#Weight_Detail_' + idx + '_Result').val('Fail');
            $('#Weight_Detail_' + idx + '_Result').removeClass('blue').removeClass('red').addClass('red');
        }


        return averageWeightM2;
    }
</script>
