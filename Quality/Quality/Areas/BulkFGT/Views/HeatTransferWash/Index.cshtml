@{
    ViewBag.Title = "Index";
    Layout = "~/Views/Shared/_Layout.cshtml";
}
<link href="~/ThirdParty/plugins/DataTables/datatables.min.css" rel="stylesheet" />
<link href="~/ThirdParty/SciCustom/css/TableStyle.css" rel="stylesheet" />
<script src="~/ThirdParty/plugins/DataTables/datatables.min.js"></script>
<link href="~/ThirdParty/plugins/jquery-ui/jquery-ui.css" rel="stylesheet" />

@model DatabaseObject.ViewModel.BulkFGT.HeatTransferWash_ViewModel

<style type="text/css">
    .input-group {
        display: flex
    }

        .input-group > input:nth-child(1) {
            flex-grow: 3
        }

        .input-group > input:nth-child(2) {
            flex-grow: 2
        }

        .input-group > input:nth-child(3) {
            flex-grow: 1
        }

    .DetailTable > tbody > tr > td > input[type="text"] {
        width: 100%;
    }

    .row {
        --bs-gutter-x: 1.5rem;
        --bs-gutter-y: 0;
        display: flex;
        flex-wrap: wrap;
        width: 95vw;
        margin-top: calc(var(--bs-gutter-y) * -1);
        margin-right: calc(var(--bs-gutter-x)/ -2);
        margin-left: calc(var(--bs-gutter-x)/ -2);
    }

    .button {
        background-color: #E00000; /* Red */
        border: none;
        color: white;
        padding: 6px 16px;
        text-align: center;
        text-decoration: none;
        display: inline-block;
        font-size: 16px;
    }

    .row > * {
        flex-shrink: 0;
        width: 100%;
        max-width: 100%;
        padding-left: calc(var(--bs-gutter-x)/ 2);
    }

    .rowHeader {
        font-size: 1.1vw;
        font-weight: bold;
    }

    .queryHeader select {
        width: 10vw;
    }

    .rowHeader input[type="text"] {
        width: 10vw;
    }

    .col-auto {
        width: auto;
    }

        .col-auto > p {
            padding: 0
        }

    .White {
        color: white !important;
    }

    .Black {
        color: black !important;
    }

    .IsEditMode {
        color: white !important;
        cursor: pointer;
    }

    .IsEditModeQuery {
        color: gray !important;
        cursor: no-drop;
    }

    #ButtonMode {
        width: 92vw;
    }

    .DataTable {
        width: 92vw;
        font-size: 1rem;
        font-weight: bold;
        border: solid 1px black;
        background-color: white;
    }

        .DataTable > tbody img {
            cursor: pointer;
        }

        .DataTable > tbody > tr:nth-of-type(odd) {
            background-color: #ffffff;
        }

        .DataTable > tbody > tr:nth-of-type(even) {
            background-color: #F0F2F2;
        }

        .DataTable > tbody > tr > td {
            border: solid 1px gray;
            padding: 0.5em;
            text-align: left;
            vertical-align: middle;
        }

        .DataTable input[type='text'], .DataTable input[type='number'] {
            width: 70%;
        }

    .bigSize {
        width: 3em;
        height: 2em;
    }
</style>

@using (Html.BeginForm("Index", ViewContext.RouteData.GetRequiredString("Controller"), new { }, FormMethod.Post, new { @id = "DetailForm" }))
{

    <div class="main-content">
        <header class="page-header">
            <div style="float:left">
                <h3>
                    <span>Heat Transfer Wash Test</span>
                </h3>
                <div class="breadcrumb">
                    <div>Home</div>
                    <div class="current">Heat Transfer Wash Test</div>
                </div>
            </div>
            <div class="breadcrumb queryHeader" style="justify-content: flex-end;">
                <h4 style="margin-right: 1em;color:white">Report No</h4>

                @Html.DropDownListFor(o => Model.Request.ReportNo, Model.ReportNo_Source, new
                {
                    @value = Model.Request.ReportNo,
                    @onchange = "ReportNoChange(this.value)"
                })
                <input id="btnNew" type="button" class="button" style="margin-left:1em;border:0;cursor:pointer;" name="New" value="New">
            </div>
        </header>

        <div class="main-area">
            <div class="content-scroll">
                <div class="inner-scroll">
                    @*查詢列*@
                    <div class="row rowHeader">
                        <div class="col-auto">
                            <p class="InfoTitle White">Brand</p>
                        </div>
                        <div class="col-auto">
                            <input id="Request_BrandID" name="Request.BrandID" type="text" value="@Model.Request.BrandID">
                            <input id="btnBrandSelectItem" type="button" class="site-btn btn-blue" style="margin:0;border:0;" value="..." />
                        </div>
                        <div class="col-auto"><p class="InfoTitle White">Season</p></div>
                        <div class="col-auto">
                            <input id="Request_SeasonID" name="Request.SeasonID" type="text" value="@Model.Request.SeasonID">
                            <input id="btnSeasonSelectItem" type="button" class="site-btn btn-blue" style="margin:0;border:0;" value="..." />
                        </div>
                        <div class="col-auto"><p class="InfoTitle White">Style</p></div>
                        <div class="col-auto">
                            <input id="Request_StyleID" name="Request.StyleID" type="text" value="@Model.Request.StyleID">
                            <input id="btnStyleSelectItem" type="button" class="site-btn btn-blue" style="margin:0;border:0;" value="..." />
                        </div>
                        <div class="col-auto"><p class="InfoTitle White">Article</p></div>
                        <div class="col-auto">
                            <input id="Request_Article" name="Request.Article" type="text" value="@Model.Request.Article">
                            <input id="btnArticleSelectItem" type="button" class="site-btn btn-blue" style="margin:0;border:0;" value="..." />
                        </div>

                        <div class="col-auto">
                            <button id="btnQuery" type="submit" name="Action:Query" class="site-btn btn-gy font1rem Black" style="padding: 0.4em;">Query</button>
                        </div>
                    </div>

                    @*按鈕列*@
                    <div style="margin-top: 1em;">
                        <table id="ButtonMode">
                            <tbody>
                                <tr>
                                    <td>
                                        <h4 id="Edit" style="margin-right: 1em;">
                                            <img src="~/Image/Icon/Edit.png" width="30" />
                                            Edit
                                        </h4>
                                    </td>
                                    <td>
                                        <h4 style="margin-right: 1em;">
                                            <button id="Save" type="submit" style="margin:0;min-width:0;background-color:transparent">
                                                <img src="~/Image/Icon/Save.png" width="30" />
                                                Save
                                            </button>
                                        </h4>
                                    </td>
                                    <td>
                                        <h4 id="Undo" style="margin-right: 1em;">
                                            <img src="~/Image/Icon/Undo.png" width="30" />
                                            Undo
                                        </h4>
                                    </td>
                                    <td>
                                        <input id="DeleteSubmit" type="submit" name="action:Delete" style="display:none" />
                                        <h4 id="Delete" style=" margin-right: 1em;">
                                            <img src="~/Image/Icon/Delete.png" width="30" />
                                            Delete
                                        </h4>
                                    </td>
                                    <td>
                                        <h4 id="Encode" style=" margin-right: 1em; ">
                                            <img src="~/Image/Icon/Lock.png" width="30" />
                                            Encode
                                        </h4>
                                    </td>
                                    <td>
                                        <h4 id="Excel" style=" margin-right: 1em;">
                                            <img src="~/Image/Icon/XLS.png" width="30" />
                                            Excel
                                        </h4>
                                    </td>
                                    <td>
                                        <h4 id="PDF" style="margin-right: 1em;">
                                            <img src="~/Image/Icon/PDF.png" width="30" />
                                            PDF
                                        </h4>
                                    </td>
                                    <td>
                                        <h4 id="SendMail" style="margin-right: 1em;">
                                            <img src="~/Image/Icon/SendMail.png" width="30" />
                                            Send to MR
                                        </h4>
                                    </td>
                                    <td>
                                        <h4 id="Picture" style=" margin-right: 1em;">
                                            <img src="~/Image/Icon/Camera.png" width="30" />
                                            Picture
                                        </h4>
                                    </td>
                                    <td style="width: 30%;">
                                    </td>
                                    <td align="right">
                                        <h4 id="New">
                                            <img src="~/Image/Icon/New.png" width="30" />
                                            New Item
                                        </h4>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    @*表頭*@
                    <div style="margin-top: 1em;">
                        <table class="DataTable">
                            <tbody>
                                <tr>
                                    <td style="width: 10vw;"><h5>Report No</h5></td>
                                    <td style="width: 20vw;">
                                        <input id="ReportNo" name="ReportNo" readonly="readonly" type="text" value="@Model.Main.ReportNo">
                                        @Html.HiddenFor(o => o.Main.TestBeforePicture)
                                        @Html.HiddenFor(o => o.Main.TestAfterPicture)
                                    </td>
                                    <td style="width: 10vw;"><h5>SP#</h5></td>
                                    <td style="width: 20vw;">
                                        @Html.TextBoxFor(o => o.Main.POID)
                                    </td>
                                    <td style="width: 10vw;"><h5>Brand</h5></td>
                                    <td style="width: 20vw;">
                                        @Html.TextBoxFor(o => o.Main.BrandID, new { @class= "Readonly" })
                                        @*<input id="btnDetailBrandSelectItem" type="button" class="site-btn btn-blue" style="margin:0;border:0;" value="..." />*@
                                    </td>
                                </tr>
                                <tr>
                                    <td><h5>Season</h5></td>
                                    <td>
                                        @Html.TextBoxFor(o => o.Main.SeasonID, new { @class = "Readonly" })
                                        @*<input id="btnDetailSeasonSelectItem" type="button" class="site-btn btn-blue" style="margin:0;border:0;" value="..." />*@
                                    </td>
                                    <td><h5>Style#</h5></td>
                                    <td>
                                        @Html.TextBoxFor(o => o.Main.StyleID, new { @class = "Readonly" })
                                        @*<input id="btnDetailStyleSelectItem" type="button" class="site-btn btn-blue" style="margin:0;border:0;" value="..." />*@
                                    </td>
                                    <td><h5>Article</h5></td>
                                    <td>
                                        @Html.TextBoxFor(o => o.Main.Article, new { @class = "Readonly" })
                                        @*<input id="btnDetailArticleSelectItem" type="button" class="OnlyEdit site-btn btn-blue" style="margin:0;border:0;" value="..." />*@
                                    </td>
                                </tr>
                                <tr>
                                    <td><h5>Line#</h5></td>
                                    <td>
                                        @Html.TextBoxFor(o => o.Main.Line, new { @maxlength="15"})
                                    </td>
                                    <td><h5>Machine#</h5></td>
                                    <td>
                                        @Html.TextBoxFor(o => o.Main.Machine, new { @maxlength = "15" })
                                    </td>
                                    <td><h5></h5></td>
                                    <td>
                                    </td>
                                </tr>
                                <tr>
                                    <td><h5>Teamwear</h5></td>
                                    <td>
                                        <div class="input-group">
                                            @Html.CheckBoxFor(o => o.Main.IsTeamwear, new { @class = "bigSize OnlyEdit", @style = "flex-grow: 0;" })
                                            <label for="Main_IsTeamwear" style="padding: 5px;">Teamwear</label>
                                        </div>
                                    </td>
                                    <td><h5>Report Date</h5></td>
                                    <td>
                                        @Html.TextBoxFor(o => o.Main.ReportDate, "{0:yyyy/MM/dd}", new { @class = "date-picker" })
                                    </td>
                                    <td><h5>Result</h5></td>
                                    <td>
                                        @Html.TextBoxFor(o => o.Main.Result, new { @class = "Readonly" })
                                    </td>
                                </tr>
                                <tr>
                                    <td><h5>Remark</h5></td>
                                    <td colspan="3">
                                        @Html.TextBoxFor(o => o.Main.Remark, new {@style="width:100%;", @maxlength = "300" })
                                    </td>
                                    <td><h5>Last Edit Name</h5></td>
                                    <td>
                                        @Html.TextBoxFor(o => o.Main.LastEditName, new { @class = "Readonly" })
                                    </td>
                                </tr>
                                <tr>
                                    <td colspan="6">
                                        <h5>HT Machine Parameter</h5>
                                    </td>
                                </tr>
                                <tr>
                                    <td colspan="2">
                                        <h5>Tempereture(°C)</h5>
                                    </td>
                                    <td>
                                        @Html.TextBoxFor(o => o.Main.Temperature, new { @type = "number", @class = "" })
                                    </td>
                                    <td colspan="2">
                                        <h5>Time(hrs)</h5>
                                    </td>
                                    <td>
                                        @Html.TextBoxFor(o => o.Main.Time, new { @class = "" })
                                    </td>
                                </tr>
                                <tr>
                                    <td colspan="2">
                                        <h5>Pressure(kg/cm2)</h5>
                                    </td>
                                    <td>
                                        @Html.TextBoxFor(o => o.Main.Pressure, new { @type = "number", @class = "" })
                                    </td>
                                    <td colspan="2">
                                        <h5>Peel Off(Hot & Cold)</h5>
                                    </td>
                                    <td>
                                        @Html.TextBoxFor(o => o.Main.PeelOff, new { @type = "number", @class = "OnlEdit" })
                                    </td>
                                </tr>
                                <tr>
                                    <td colspan="6">
                                        <h5>Washing Condition</h5>
                                    </td>
                                </tr>
                                <tr>
                                    <td colspan="2">
                                        <h5>Cycles</h5>
                                    </td>
                                    <td>
                                        @Html.DropDownListFor(o => Model.Main.Cycles, Model.Cycles_Source, new
                                        {
                                            @value = Model.Main.Cycles,
                                        })
                                    </td>
                                    <td colspan="2">
                                        <h5>°C</h5>
                                    </td>
                                    <td>
                                        @Html.DropDownListFor(o => Model.Main.PeelOff, Model.TemperatureUnit_Source, new
                                        {
                                            @value = Model.Main.PeelOff,
                                        })
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    @*表身*@
                    <div style="margin-top: 1em; width: 92vw; overflow:auto;">
                        <table cellspacing="100" class="DetailTable DataTable table table-striped display;" style="width: 120vw">
                            <thead>
                                <tr>

                                    <th><h4>Fabric Ref No.</h4></th>
                                    <th><h4>HT Ref No.</h4></th>
                                    <th><h4>Result</h4></th>
                                    <th><h4>Remark</h4></th>
                                    <th><h4>Last Update</h4></th>
                                    <th><h4></h4></th>
                                </tr>

                            </thead>
                            <tbody>

                                @for (int i = 0; i <= Model.Details.Count - 1; i++)
                                {
                                    <tr>
                                        <td>
                                            @Html.TextBoxFor(o => Model.Details[i].FabricRefNo, "", new { @class = "OnlyEdit" })
                                        </td>
                                        <td>
                                            @Html.TextBoxFor(o => Model.Details[i].HTRefNo, "", new { @class = "OnlyEdit" })
                                        </td>
                                        <td>
                                            @Html.TextBoxFor(o => Model.Details[i].Result, "", new { @class = "OnlyEdit" })
                                        </td>
                                        <td>
                                            @Html.TextBoxFor(o => Model.Details[i].Remark, "", new { @class = "OnlyEdit" })
                                        </td>
                                        <td>
                                            @Html.DisplayFor(o => Model.Details[i].LastEditName, "", new { @class = "OnlyEdit" })
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
}

<script type="text/javascript">
    var msg;
    var EditMode;
    var EditType;
    $(function () {
        msg = new MessagerAlert();
        EditMode = false;
        @Html.Raw(Model.ErrorMessage)
        IsEditModeChange();

        if (!$("body").hasClass("sidebar-collapse")) {
            $(".menu-trigger").click();
        }
    });

    function IsEditModeChange() {
        EditModeButtionBind();
        Clear();
        $(".readonly").attr("disabled", "disabled");
        if (EditMode) {
            $(".queryHeader select").attr("disabled", "disabled");
            $('#btnNew').unbind('click').addClass("IsEditModeQuery");

            $(".rowHeader input[type='text']").attr("disabled", "disabled");
            $(".rowHeader input[type='button']").unbind('click').addClass("IsEditModeQuery");
            $('#btnQuery').addClass("IsEditModeQuery");

            $("#Edit, #Delete, #SendMail, #PDF").removeClass("IsEditMode");
            $('#Save, #Undo, #New, #Picture').addClass("IsEditMode");
            $('.DetailTable input,.DetailTable select:not(.NotEdit)').removeAttr("disabled");

            if (EditType == "New") {
                $(".DataTable input:not(#ReportNo,#LastEditName,.Readonly), .DataTable select").removeAttr("disabled");
            }
            else {
                $(".OnlyEdit").removeAttr("disabled").removeAttr("readonly");
            }

            $(".DetailTable img").removeClass('display-None');

            DetailButtonBind();
            DetailDetailButtonBind();

            $('#btnQuery').on('click', function () {
                return false;
            });
        }
        else {
            $(".queryHeader select").removeAttr("disabled");
            $(".rowHeader input[type='text']").removeAttr("disabled");
            $(".rowHeader input[type='button']").removeClass("IsEditModeQuery");
            $('#btnNew').removeClass("IsEditModeQuery");
            $('#Save').removeClass("IsEditMode");
            $('#Undo, #New').unbind('click').removeClass("IsEditMode");
            $('#btnQuery').unbind('click').removeClass("IsEditModeQuery");

            QueryButtonBind();

            if ($('#ReportNo').val() != undefined && $('#ReportNo').val() != '') {
                $("#Edit, #Delete, #Picture, #PDF, #SendMail").addClass("IsEditMode");
            }
            else {
                $("#Edit, #Picture, #Delete, #PDF, #SendMail").unbind('click').removeClass("IsEditMode");
            }

            $(".DataTable input, .DataTable select").attr("disabled", "disabled");
            $('.DetailTable input,.DetailTable select').attr("disabled");
            $(".DetailTable img").addClass('display-None');


            $('#btnQuery').on('click', function () {
                if (EditType != "New") {
                    if ($('#Request_BrandID').val() == '' || $('#Request_SeasonID').val() == '' || $('#Request_StyleID').val() == '' || $('#Request_Article').val() == '') {
                        msg.WithError("Style, Brand, Season and Article cannot be empty");
                        return false;
                    }
                }
            });
        }

    }

    function Clear() {
        if (EditType == "New") {
            $(".DataTable input[type='text'], .DataTable input[type='number'], .DataTable select").val('');
            $('#Result').html('');
        }
    }

    function ReportNoChange(value) {
        $('#btnQuery').unbind('click').click();
    }

    function QueryButtonBind() {
        $('#btnBrandSelectItem').on('click', function () {
            var para = "?TargetID=Request_BrandID";
            window.open('@Url.Action("BrandList","PublicWondow",new{Area=""})' + para, 'Brand', config = 'toolbar=no,status=no,location=no,width=400,height=650');
        });

        $('#btnSeasonSelectItem').on('click', function () {
            var para = "?TargetID=Request_SeasonID&BrandID=" + $('#Request_BrandID').val();
            window.open('@Url.Action("SeasonList","PublicWondow",new{Area=""})' + para, 'Season', config = 'toolbar=no,status=no,location=no,width=400,height=650');
        });

        $('#btnStyleSelectItem').on('click', function () {
            var para = "?TargetID=Request_StyleID&BrandID=" + $('#Request_BrandID').val() + "&SeasonID=" + $('#Request_SeasonID').val();
            window.open('@Url.Action("StyleList","PublicWondow",new{Area=""})' + para, 'Style', config = 'toolbar=no,status=no,location=no,width=400,height=650');
        });

        $('#btnArticleSelectItem').on('click', function () {
            if ($('#Request_BrandID').val() == '' || $('#Request_SeasonID').val() == '' || $('#Request_StyleID').val() == '') {
                msg.WithError('Please input style, brand and season before choose article.');
                return;
            }

            var para = "?TargetID=Request_Article&OrderID=&StyleUkey=0&BrandID=" + $('#Request_BrandID').val() + "&SeasonID=" + $('#Request_SeasonID').val() + "&StyleID=" + $('#Request_StyleID').val();
            window.open('@Url.Action("ArticleList","PublicWondow",new{Area=""})' + para, 'Article', config = 'toolbar=no,status=no,location=no,width=400,height=650');
        });

        blurEvent('Request_');
    }

    function blurEvent(name) {

        $("#Main_POID").unbind('blur').blur(function () {
            if ($(this).val() == '') {
                return;
            }

            $.ajax({
                url: "@Url.Action("SPBlur", new{Area= "BulkFGT" })",
                type: 'POST',
                contentType: "application/json; charset=utf-8",
                data: JSON.stringify({ POID: $(this).val(), ReturnType: "JSON" }),
                async: true,
                success: function (data) {
                    if (data.ErrMsg != "") {
                        $("#Main_POID").val('');
                        msg.WithError(data.ErrMsg);
                    }
                    else {
                        if (data.BrandID != "") {
                            $('#Main_BrandID').val(data.BrandID);
                        }

                        if (data.SeasonID != "") {
                            $('#Main_SeasonID').val(data.SeasonID);
                        }

                        if (data.StyleID != "") {
                            $('#Main_StyleID').val(data.StyleID);
                        }


                        if (data.Article != "") {
                            $('#Main_Article').val(data.Article);
                        }

                    }
                },
                error: function (xhr, ajaxOptions, thrownError) {
                    console.log(xhr.responseText);
                }
            });
        });

        $("#" + name + "BrandID").blur(function () {
            if ($(this).val() == '') {
                if (name == '') {
                    ClearColor();
                }

                return;
            }

            $.ajax({
                url: "@Url.Action("BrandList","PublicWondow",new{Area=""})",
                type: 'POST',
                contentType: "application/json; charset=utf-8",
                data: JSON.stringify({ BrandID: $(this).val(), ReturnType: "JSON" }),
                async: true,
                success: function (data) {
                    if (data.length == 0) {
                        $("#" + name + "BrandID").val('');
                        msg.WithError('Brand Not Found');
                    }

                    if (name == '') {
                        GetAccessoryRefNoList();
                    }

                    ReportNoClear(name);
                },
                error: function (xhr, ajaxOptions, thrownError) {
                    console.log(xhr.responseText);
                }
            });
        });

        $("#" + name + "SeasonID").blur(function () {
            if ($(this).val() == '') {
                if (name == '') {
                }

                return;
            }


            var BrandID = $('#' + name + 'BrandID').val();
            $.ajax({
                url: "@Url.Action("SeasonList","PublicWondow",new{Area=""})",
                type: 'POST',
                contentType: "application/json; charset=utf-8",
                data: JSON.stringify({ BrandID: BrandID, SeasonID: $(this).val(), ReturnType: "JSON" }),
                async: true,
                success: function (data) {
                    if (data.length == 0) {
                        $("#" + name + "SeasonID").val('');
                        msg.WithError('Season Not Found');
                    }

                    if (name == '') {
                        GetAccessoryRefNoList();
                    }

                    ReportNoClear(name);
                },
                error: function (xhr, ajaxOptions, thrownError) {
                    console.log(xhr.responseText);
                }
            });
        });

        $("#" + name + "StyleID").blur(function () {
            if ($(this).val() == '') {

                if (name == '') {
                }

                return;
            }


            var BrandID = $('#' + name + 'BrandID').val();
            var SeasonID = $('#' + name + 'SeasonID').val();
            $.ajax({
                url: "@Url.Action("StyleList","PublicWondow",new{Area=""})",
                type: 'POST',
                contentType: "application/json; charset=utf-8",
                data: JSON.stringify({ BrandID: BrandID, SeasonID: SeasonID, StyleID: $(this).val(), ReturnType: "JSON" }),
                async: true,
                success: function (data) {
                    if (data.length == 0) {
                        $("#" + name + "StyleID").val('');
                        msg.WithError('Style Not Found');
                    }

                    if (name == '') {
                        GetAccessoryRefNoList();
                    }

                    ReportNoClear(name);
                },
                error: function (xhr, ajaxOptions, thrownError) {
                    console.log(xhr.responseText);
                }
            });
        });

        $('#' + name + 'Article').blur(function () {
            if ($(this).val() == '') {
                return;
            }

            var BrandID = $('#' + name + 'BrandID').val();
            var SeasonID = $('#' + name + 'SeasonID').val();
            var StyleID = $('#' + name + 'StyleID').val();

            $.ajax({
                url: "@Url.Action("ArticleList","PublicWondow",new{Area=""})",
                type: 'POST',
                contentType: "application/json; charset=utf-8",
                data: JSON.stringify({ BrandID: BrandID, StyleUkey: 0, SeasonID: SeasonID, StyleID: StyleID, Article: $(this).val(), ReturnType: "JSON" }),
                async: true,
                success: function (data) {
                    if (data.length == 0) {
                        $("#" + name + "Article").val('');
                        msg.WithError('Article Not Found');
                    }

                    ReportNoClear(name);
                },
                error: function (xhr, ajaxOptions, thrownError) {
                    console.log(xhr.responseText);
                }
            });
        });

        $("#T1Subcon").unbind('blur').blur(function () {
            if ($(this).val() == '') {
                $("#T1SubconAbb").val('');
                return;
            }

            $.ajax({
                url: "@Url.Action("LocalSuppList","PublicWondow",new{Area=""})",
                type: 'POST',
                contentType: "application/json; charset=utf-8",
                data: JSON.stringify({ SuppID: $(this).val(), ReturnType: "JSON" }),
                async: true,
                success: function (data) {
                    if (data.length == 0) {
                        $("#T1Subcon").val('');
                        $("#T1SubconAbb").val('');
                        msg.WithError('T1/SubconName');
                    }
                    else {
                        $("#T1Subcon").val(data[0].ID);
                        $("#T1SubconAbb").val(data[0].Name);
                    }
                },
                error: function (xhr, ajaxOptions, thrownError) {
                    console.log(xhr.responseText);
                }
            });
        });

        $("#T2Supplier").unbind('blur').blur(function () {
            if ($(this).val() == '') {
                $("#T2SupplierAbb").val('');
                return;
            }

            $.ajax({
                url: "@Url.Action("TPESuppList","PublicWondow",new{Area=""})",
                type: 'POST',
                contentType: "application/json; charset=utf-8",
                data: JSON.stringify({ SuppID: $(this).val(), ReturnType: "JSON" }),
                async: true,
                success: function (data) {
                    if (data.length == 0) {
                        $("#T2Supplier").val('');
                        $("#T2SupplierAbb").val('');
                        msg.WithError('T2/SupplierName');
                    }
                    else {
                        $("#T2Supplier").val(data[0].ID);
                        $("#T2SupplierAbb").val(data[0].Name);
                    }
                },
                error: function (xhr, ajaxOptions, thrownError) {
                    console.log(xhr.responseText);
                }
            });
        });

        $("#Technician").unbind('blur').blur(function () {
            if ($(this).val() == '') {
                $("#Technician").val('');
                $("#TechnicianDesc").val('');
                return;
            }

            $.ajax({
                url: "@Url.Action("TechnicianList", "PublicWondow",new{Area=""})",
                type: 'POST',
                contentType: "application/json; charset=utf-8",
                data: JSON.stringify({ CallFunction: "MockupOven", ID: $(this).val(), ReturnType: "JSON"  }),
                async: true,
                success: function (data) {
                    if (data.length == 0) {
                        $("#Technician").val('');
                        $("#TechnicianDesc").val('');
                        msg.WithError('Technician');
                    }
                    else {
                        $("#Technician").val(data[0].ID);
                        $("#TechnicianDesc").val(data[0].Name + ' Ext.' + data[0].ExtNo);
                    }

                },
                error: function (xhr, ajaxOptions, thrownError) {
                    console.log(xhr.responseText);
                }
            });
        });

        $('#MR').unbind('blur').on('blur', function () {
            if ($(this).val() == "") {
                $("#MR").val('');
                $("#MRDesc").val('');
                $("#MRMail").val('');
                return;
            }

            $.ajax({
                url: "@Url.Action("Pass1List", "PublicWondow",new { Area=""})",
                type: 'POST',
                contentType: "application/json; charset=utf-8",
                data: JSON.stringify({ ID:$(this).val(), ReturnType: "JSON" }),
                async: true,
                success: function (data) {
                    if (data.length == 0) {
                        $("#MR").val('');
                        $("#MRDesc").val('');
                        $("#MRMail").val('');
                        msg.WithError('MR Not Found');
                    }
                    else
                    {
                        $("#MR").val(data[0].ID);
                        $("#MRDesc").val(data[0].Name + ' Ext.' + data[0].ExtNo);
                        $("#MRMail").val(data[0].EMail);
                    }
                },
                error: function (xhr, ajaxOptions, thrownError) {
                    console.log(xhr.responseText);
                }
            });
        });
    }

    function EditModeButtionBind() {
        $('#Edit').on('click', function () {
            if ($('#ReportNo').val() != null && $('#ReportNo').val() != "") {
                EditMode = true;
                EditType = "";
                $("#Save").attr("name", "Action:Edit");
                IsEditModeChange();
            }
        });

        $('#btnNew').on('click', function () {
            EditMode = true;
            EditType = "New";
            $("#Save").attr("name", "Action:New");
            $("#TestBeforePicture").val('');
            $("#TestAfterPicture").val('');
            IsEditModeChange();

            $('.DetailTable > tbody > tr').each(function () {
                $(this).remove();
            });

        });

        $('#New').unbind('click').on('click', function () {
            if (!EditMode) {
                return;
            }
            AddDetailRow();
        });

        $('#Save').on('click', function (e) {
            if (EditMode == false) {
                return false;
            }

            var detail = [];
            var ErrMsg = "";

            if ($('#BrandID').val() == '' || $('#SeasonID').val() == '' || $('#StyleID').val() == '' || $('#Article').val() == ''
                || $('#BrandID').val() == undefined || $('#SeasonID').val() == undefined || $('#StyleID').val() == undefined || $('#Article').val() == undefined) {
                ErrMsg += "Style, Brand, Season and Article cannot be empty<br/>";
            }

            if (ErrMsg != "") {
                msg.WithError(ErrMsg);
                return false;
            }

            // 重新調整index 順序。
            $('.DetailTable > tbody > tr').each(function (index, data) {
                var idx = $(this).closest('tr').attr('idx');
                if (idx != index) {
                    $.each($(this).find("input[id^='MockupOven_Detail']"), function () {
                        var tableName = $(this).attr('name').substr(0, $(this).attr('name').indexOf("["));
                        var rollName = $(this).attr('name').substr($(this).attr('name').indexOf("]") + 2, $(this).attr('name').length - $(this).attr('name').indexOf("]"));
                        $(this).attr("id", tableName + "_" + index.toString() + "__" + rollName);
                        $(this).attr("name", tableName + "[" + index.toString() + "]." + rollName);
                    });

                    $.each($(this).find("select[id^='MockupOven_Detail']"), function () {
                        var tableName = $(this).attr('name').substr(0, $(this).attr('name').indexOf("["));
                        var rollName = $(this).attr('name').substr($(this).attr('name').indexOf("]") + 2, $(this).attr('name').length - $(this).attr('name').indexOf("]"));
                        $(this).attr("id", tableName + "_" + index.toString() + "__" + rollName);
                        $(this).attr("name", tableName + "[" + index.toString() + "]." + rollName);
                    });
                }
            });

            $(".rowHeader input[type='text']").removeAttr("disabled");
            $(".DataTable input, .DataTable select").removeAttr("disabled");
        });

        $('#Undo').on('click', function () {
            EditMode = false;
            IsEditModeChange();
            if (EditType != "New") {
                $('#btnQuery').unbind('click').click();
            }
            else {
                if ($('#Request_BrandID').val() != '' || $('#Request_SeasonID').val() != '' || $('#Request_StyleID').val() != '' || $('#Request_Article').val() != '') {
                    $('#btnQuery').unbind('click').click();
                }
            }

            EditType = "";
        });

        $('#Delete').on('click', function (e) {
            if (EditMode == false && $('#ReportNo').val() != null && $('#ReportNo').val() != "") {
                e.preventDefault();
                msg.WithConfirm('Do you want to delete the data ?',
                    function () {
                        $("#DeleteSubmit").click();
                    }, null);
            }
        });

        $('#Picture').on('click', function () {
            var para = "?Title=" + $('.page-header span').html() + "&EditMode=" + EditMode;
            para += "&" + "Table=MockupOven";
            para += "&" + "TargetBeforeColumn=TestBeforePicture";
            para += "&" + "TargetAfterColumn=TestAfterPicture";
            para += "&" + "BeforeColumn=TestBeforePicture";
            para += "&" + "AfterColumn=TestAfterPicture";
            para += "&" + "PKey_1=ReportNo";
            para += "&" + "PKey_1_Val=" + $('#ReportNo').val();
            window.open('@Url.Action("PictureList", "PublicWondow",new { Area=""})' + para, 'Picture List', config = 'toolbar=no,status=no,location=no,width=1024,height=750');
        });

        $('#PDF').on('click', function () {
            if ($('#ReportNo').val() == ""
                || $('#Request_BrandID').val() == ""
                || $('#Request_SeasonID').val() == ""
                || $('#Request_StyleID').val() == ""
                || $('#Request_Article').val() == "") {

                return false;
            }

            var mockupOven_Request = {
                ReportNo: $('#ReportNo').val(),
                BrandID: $('#Request_BrandID').val(),
                SeasonID: $('#Request_SeasonID').val(),
                StyleID: $('#Request_StyleID').val(),
                Article: $('#Request_Article').val(),
            };
            $.ajax({
                url: "@Url.Action("ToPDF", "MockupOvenTest", new { Area = "BulkFGT" })",
                type: 'POST',
                contentType: "application/json; charset=utf-8",
                data: JSON.stringify({ mockupOven_Request }),
                async: false,
                success: function (data) {
                    if (data.Result) {
                        window.location.href = data.reportPath;
                    }
                    else {
                        console.log(data.ErrorMessage);
                        msg.WithError(data.ErrorMessage);
                    }
                },
                error: function (xhr, ajaxOptions, thrownError) {
                    console.log(xhr.responseText);
                }
            });
        });

        $('#SendMail').on('click', function () {
            if ($('#ReportNo').val() == ""
                || $('#Request_BrandID').val() == ""
                || $('#Request_SeasonID').val() == ""
                || $('#Request_StyleID').val() == ""
                || $('#Request_Article').val() == "") {

                return false;
            }

            var mockupOven_Request = {
                ReportNo: $('#ReportNo').val(),
                BrandID: $('#Request_BrandID').val(),
                SeasonID: $('#Request_SeasonID').val(),
                StyleID: $('#Request_StyleID').val(),
                Article: $('#Request_Article').val(),
            };
            $.ajax({
                url: "@Url.Action("ToPDF", new { Area = "BulkFGT" })",
                type: 'POST',
                contentType: "application/json; charset=utf-8",
                data: JSON.stringify({ mockupOven_Request }),
                async: false,
                success: function (data) {
                    if (data.Result) {
                        var para = "?To=" + $('#MRMail').val();
                        para += "&CC=" + '@ViewBag.UserMail';
                        para += "&Subject=" + "Mockup Oven Test – ReportNo:" + $('#ReportNo').val() + " – Style: " + $('#StyleID').val();
                        para += "&Body=" + "Attachment is Mockup Oven Test– ReportNo:" + $('#ReportNo').val() + " detail data";
                        para += "&file=" + data.FileName;
                        window.open('@Url.Action("SendMailer", "SendMailAttachfiles", new { Area=""})' + para, 'SendMail', config = 'toolbar=no,status=no,location=no,width=800,height=600');
                    }
                    else {
                        msg.WithError(data.ErrorMessage);
                    }
                },
                error: function (xhr, ajaxOptions, thrownError) {
                    console.log(xhr.responseText);
                }
            });
        });
    }

    function DetailButtonBind() {
        $('#btnDetailBrandSelectItem').on('click', function () {
            var para = "?TargetID=BrandID";
            window.open('@Url.Action("BrandList","PublicWondow",new{Area=""})' + para, 'BrandID', config = 'toolbar=no,status=no,location=no,width=400,height=650');
        });

        $('#btnDetailSeasonSelectItem').on('click', function () {
            var para = "?TargetID=SeasonID&BrandID=" + $('#BrandID').val();
            window.open('@Url.Action("SeasonList","PublicWondow",new{Area=""})' + para, 'SeasonID', config = 'toolbar=no,status=no,location=no,width=400,height=650');
        });

        $('#btnDetailStyleSelectItem').on('click', function () {
            var para = "?TargetID=StyleID&BrandID=" + $('#BrandID').val() + "&SeasonID=" + $('#SeasonID').val();
            window.open('@Url.Action("StyleList","PublicWondow",new{Area=""})' + para, 'StyleID', config = 'toolbar=no,status=no,location=no,width=400,height=650');
        });

        $('#btnDetailArticleSelectItem').on('click', function () {
            var para = "?TargetID=Article&OrderID=&StyleUkey=0&BrandID=" + $('#BrandID').val() + "&SeasonID=" + $('#SeasonID').val() + "&StyleID=" + $('#StyleID').val();
            window.open('@Url.Action("ArticleList","PublicWondow",new{Area=""})' + para, 'Article', config = 'toolbar=no,status=no,location=no,width=400,height=650');
        });

        $('#btnDetailSubconNameSelectItem').on('click', function () {
            window.open('@Url.Action("LocalSuppList","PublicWondow",new{Area=""})', 'T1/SubconName', config = 'toolbar=no,status=no,location=no,width=900,height=650');
        });

        $('#btnDetailSupplierNameSelectItem').on('click', function () {
            window.open('@Url.Action("TPESuppList","PublicWondow",new{Area=""})', 'T2/SupplierName', config = 'toolbar=no,status=no,location=no,width=800,height=650');
        });

        $('#btnDetailTechnicianSelectItem').on('click', function () {
            var para = "?CallFunction=MockupOven";
            window.open('@Url.Action("TechnicianList", "PublicWondow",new{Area=""})' + para, 'Technician', config = 'toolbar=no,status=no,location=no,width=800,height=650');
        });

        $('#btnDetailMRSelectItem').on('click', function () {
            window.open('@Url.Action("Pass1List", "PublicWondow",new{Area=""})', 'MR', config = 'toolbar=no,status=no,location=no,width=800,height=650');
        });


        blurEvent("");
    }

    function ClearColor() {
        $('.AFColor').each(function () {
            $(this).val('');
        });
    }

    function DetailDetailButtonBind() {
        $('.btnArtworkColorItem').on('click', function () {
            var brandid = $('#BrandID').val();
            if (brandid == '') {
                msg.WithError('Brand is null');
                return;
            }

            var idx = $(this).attr("idv");
            var para = "?TargetID=" + idx + "__ArtworkColor&BrandID=" + brandid + "&Title=Artwork Color";
            window.open('@Url.Action("ColorList", "PublicWondow",new{Area=""})' + para, 'Artwork Color', config = 'toolbar=no,status=no,location=no,width=400,height=650');
        });

        $('.btnFabricColorItem').on('click', function () {
            var brandid = $('#BrandID').val();
            if (brandid == '') {
                msg.WithError('Brand is null');
                return;
            }

            var idx = $(this).attr("idv");
            var para = "?TargetID=" + idx + "__FabricColor&BrandID=" + brandid + "&Title=Fabric Color";
            window.open('@Url.Action("ColorList", "PublicWondow",new{Area=""})' + para, 'Fabric Color', config = 'toolbar=no,status=no,location=no,width=400,height=650');
        });

        $('.detailDelete').unbind('click').on('click', function () {
            var t = $(this);

            msg.WithConfirm('Do you want to delete the data ?',
                function () {
                    t.parents().parents('tr').remove();
                    msg.WithSuccess("Delete Success");
                }, null);
        });
    }

    function GetBrandList(data, targetID) {
        $('#' + targetID).val(data);
        
        GetAccessoryRefNoList();
        ClearColor();
        ReportNoClear(targetID);
    }

    function GetSeasonList(data, targetID) {
        $('#' + targetID).val(data);
        
        GetAccessoryRefNoList();
        ReportNoClear(targetID);
    }

    function GetStyleList(data, targetID) {
        $('#' + targetID).val(data);
        
        GetAccessoryRefNoList();
        ReportNoClear(targetID);
    }

    function GetArticleList(data, targetID) {
        $('#' + targetID).val(data);
        ReportNoClear(targetID);
    }

    function ReportNoClear(targetID) {
        if (targetID.indexOf('Request_') > -1) {
            $('#Request_ReportNo').html('');
        }
    }

    function GetLocalSupp(data) {
        $('#T1Subcon').val(data.ID);
        $('#T1SubconAbb').val(data.Name);
    }

    function GetTPESupp(data) {
        $('#T2Supplier').val(data.ID);
        $('#T2SupplierAbb').val(data.Name);
    }

    function GetTechnician(data) {
        $('#Technician').val(data.ID);
        $('#TechnicianDesc').val(data.Name + " Ext. " + data.ExtNo);
    }

    function GetPass1(data) {
        $('#MR').val(data.ID);
        $('#MRDesc').val(data.Name + " Ext. " + data.ExtNo);
        $('#MRMail').val(data.EMail);
    }

    function GetColor(pickList, targetID) {
        var id = [];
        var name = [];
        $.each(pickList, function (idx, obj) {
            id.push(obj.ID);
            name.push(obj.Name);
        });

        $('#MockupOven_Detail_' + targetID ).val(id.join(';'));
        $('#MockupOven_Detail_' + targetID + 'Name').val(name.join(';'));
    }

    function selectChange(obj) {
        var result = $(obj).val();
        if (result == "Pass") {
            $(obj).removeClass('red').addClass('blue');
        }
        else {
            $(obj).removeClass('blue').addClass('red');
        }

        var key = $(obj).parents('td').parents('tr').children('td').find("input[type='hidden']").attr('idx');

        var resultChange = document.getElementById("MockupOven_Detail_" + key + "__ResultChange").value;
        var resultStain = document.getElementById("MockupOven_Detail_" + key + "__ResultStain").value;

        if (resultChange == "Fail" || resultStain == "Fail") {
            document.getElementById("MockupOven_Detail_" + key + "__Result").value = 'Fail';
        }
        else {
            document.getElementById("MockupOven_Detail_" + key + "__Result").value = 'Pass';
        }

        $("#MockupOven_Detail_" + key + "__Result").removeClass("blue").removeClass("red");;
        var detailResultColor = document.getElementById("MockupOven_Detail_" + key + "__Result").value == "Pass" ? "blue" : "red";
        $("#MockupOven_Detail_" + key + "__Result").addClass(detailResultColor);

    }

    function AddDetailRow() {
        var BrandID = $('#BrandID').val();
        var SeasonID = $('#SeasonID').val();
        var StyleID = $('#StyleID').val();

        var lastNO;
        if ($('.DetailTable > tbody > tr').length > 0) {
            lastNO = parseInt($('.DetailTable > tbody > tr:last-child > td > input[type="hidden"] ').attr('idx')) + 1;
        }
        else {
            lastNO = 0;
        }

        $.ajax({
            url: "@Url.Action("AddDetailRow", "MockupOvenTest", new { Area = "BulkFGT" })",
            type: 'POST',
            contentType: "application/json; charset=utf-8",
            data: JSON.stringify({ lastNO: lastNO, BrandID: BrandID, SeasonID: SeasonID, StyleID: StyleID }),
            async: false,
            success: function (data) {
                $('.DetailTable > tbody').append(data);
                DetailDetailButtonBind();
            },
            error: function (xhr, ajaxOptions, thrownError) {
                console.log(xhr.responseText);
            }
        });
    }

    function GetPicture(data) {
        $('#TestBeforePicture').val(data.BeforePicture.replace("data:image/png;base64,", ""));
        $('#TestAfterPicture').val(data.AfterPicture.replace("data:image/png;base64,", ""));
    }

    function FailMail() {
        var para = "?Title=" + $('.page-header span').html() + "&FactoryID=@ViewBag.FactoryID&Type=BulkFGT&ExitReload=False";
        window.open('@Url.Action("TestFailMailList", "PublicWondow",new { Area=""})' + para, 'Mail List', config = 'toolbar=no,status=no,location=no,width=650,height=750');
    }

    function GetTestFailMailList(data) {
        var to = "";
        var cc = "";
        $.each(data, function (index, value) {
            to += value.To + ';';
            cc += value.CC + ';';
        });

        $.ajax({
            url: "@Url.Action("FailMail", "MockupOvenTest", new { Area = "BulkFGT" })",
            type: 'POST',
            contentType: "application/json; charset=utf-8",
            data: JSON.stringify({ ReportNo: $('#ReportNo').val(), TO: to, CC: cc }),
            async: false,
            success: function (data) {
                if (data.result) {
                    msg.WithSuccess("Success");
                }
                else {
                    msg.WithWarning(data.resultMsg);
                }
            },
            error: function (xhr, ajaxOptions, thrownError) {
                // console.log(xhr.responseText);
                msg.WithWarningCheck(xhr.responseText, function () {
                    location.reload();
                });
            }
        });
    }

</script>